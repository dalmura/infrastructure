---
nameOverride: vms

server:
  retentionPeriod: 6M

  extraArgs:
    vmalert.proxyURL: http://victoria-metrics-alert-vma-server.victoria-metrics.svc.cluster.local:8880/

  scrape:
    enabled: true

    extraScrapeConfigs:
      - job_name: victoria-logs-single
        static_configs:
          - targets:
              - http://victoria-logs-single-vls-server.victoria-logs.svc.cluster.local:9428/metrics
      # Longhorn metrics suck, the service only sends you to _one_ of the manager pods
      # And each manager pod serves up its own metrics
      # So there's no simple way to scrape all pods combined
      # See below for how to properly do it
      #- job_name: longhorn
      #  static_configs:
      #    - targets:
      #        - http://longhorn-backend.longhorn-system.svc.cluster.local:9500/metrics
      - job_name: longhorn
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            regex: "longhorn-system"
            action: keep
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: "longhorn-manager"
            action: keep
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            regex: "9500"
            action: keep
    action: keep

  persistentVolume:
    size: 20Gi
    storageClassName: cluster-nobackup

  ingress:
    enabled: true
    annotations:
      cert-manager.io/cluster-issuer: dalmura-letsencrypt-prod
      external-dns.alpha.kubernetes.io/hostname: vms.indigo.dalmura.cloud
      traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
      traefik.ingress.kubernetes.io/router.middlewares: authentik-authentik@kubernetescrd
    hosts:
      - name: vms.indigo.dalmura.cloud
        path:
          - /
        port: http
    ingressClassName: ingress-private
    tls:
      - hosts:
          - vms.indigo.dalmura.cloud
        secretName: vms-cert
