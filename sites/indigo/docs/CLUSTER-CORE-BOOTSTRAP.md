# Creating workload cluster dal-k8s-core-1

After configuring Sidero with:
* Server Classes and Environments
* Servers

We're ready to create dal-k8s-core-1 and allocate the Servers

To do this you'll have to have onboarded:
* 3x rpi4.4gb.arm64 for the Control Plane
* 3x rpi4.8gb.arm64 for Worker Pool #1

So we should be able to run:
```bash
kubectl --kubeconfig kubeconfigs/dal-k8s-mgmt-1 get serverclasses
```

And see 3x `AVAILABLE` servers in both the `rpi4.4gb.arm64` and `rpi4.8gb.arm64` ServerClasses.

## Create the cluster in Sidero

```bash
mkdir -p sidero/clusters/

export CONTROL_PLANE_SERVERCLASS=rpi4.4gb.arm64
# Temporary until we have rpi4.4gb.arm64 in stock
export CONTROL_PLANE_SERVERCLASS=rpi4.8gb.arm64
export WORKER_SERVERCLASS=rpi4.8gb.arm64
export TALOS_VERSION=v1.3.1
export KUBERNETES_VERSION=v1.26.0
export CONTROL_PLANE_PORT=6443
export CONTROL_PLANE_ENDPOINT=192.168.77.3

clusterctl generate cluster dal-k8s-core-1 \
    -i sidero \
    --kubeconfig kubeconfigs/dal-k8s-mgmt-1 \
    --target-namespace sidero-system \
    > sidero/clusters/dal-k8s-core-1.yaml
```

The above will create a 'cluster configuration' that we can apply back to k8s to kick off creation of the cluster. It contains the following Resources in 3 logical groups (cluster, control plane, worker pools). The diagram also shows off an extra Worker Pool that isn't generated by default, but just shows how you'd go about having multiple Server Classes in a single cluster.

![cluster api hierarchy](imgs/core-cluster-api-resources.jpg?raw=true "Cluster API Hierarchy")

All the above Resources descriptions can be found conveniently on the [Sidero resources page](https://www.sidero.dev/latest/overview/resources/)

We are using `rpi4.4gb.arm64` Server Class for the Control Plane nodes, `rpi4.8gb.arm64` Server Class for the Worker nodes, latest support versions for Talos and k8s and `192.168.77.3` as our allocated VIP from our [network config](https://github.com/dalmura/network/blob/main/sites/indigo/networks.yml#L53).

The modifications we've done to the default resources are:
* Control Plane
  * Updated `TalosControlPlane` to include `configPatches` for the VLANs & VIPs
* Worker Pools
  * Updated `TalosConfigTemplate` to include `configPatches` for the VLANs

Instead of simply applying the generated yaml back, we're going to break it up into:
1. `sidero/clusters/dal-k8s-core-1/control-plane.yaml` - Cluster & Control Plane
2. `sidero/clusters/dal-k8s-core-1/worker-pool-rpi4-8gb-arm64.yaml` - Worker Pool (rpi4.8gb.arm64)
3. `sidero/clusters/dal-k8s-core-1/worker-pool-dell-r320-amd64.yaml` - Worker Pool (dell.r320.amd64)

We'll then apply these back to k8s:
```bash
# Create the cluster & control plane
kubectl --kubeconfig kubeconfigs/dal-k8s-mgmt-1 apply -f sidero/clusters/dal-k8s-core-1/control-plane.yaml
cluster.cluster.x-k8s.io/dal-k8s-core-1 created
metalcluster.infrastructure.cluster.x-k8s.io/dal-k8s-core-1 created
metalmachinetemplate.infrastructure.cluster.x-k8s.io/dal-k8s-core-1-cp created
taloscontrolplane.controlplane.cluster.x-k8s.io/dal-k8s-core-1-cp created

# Create a worker pool of 8gb rpi4's
kubectl --kubeconfig kubeconfigs/dal-k8s-mgmt-1 apply -f sidero/clusters/dal-k8s-core-1/worker-pool-rpi4-8gb-arm64.yaml
```

You can then verify if Servers are being allocated to Clusters:
```bash
kubectl --kubeconfig kubeconfigs/dal-k8s-mgmt-1 get clusters -A
NAMESPACE       NAME             PHASE         AGE   VERSION
sidero-system   dal-k8s-core-1   Provisioned   46s

kubectl --kubeconfig kubeconfigs/dal-k8s-mgmt-1 get servers
NAME                                   HOSTNAME         ACCEPTED   CORDONED   ALLOCATED   CLEAN   POWER   AGE
00d03115-0000-0000-0000-e45f019d4ca8   192.168.77.151   true                  true        false   on      3d23h
00d03115-0000-0000-0000-e45f019d4e19   192.168.77.152   true                              true    on      3d22h

kubectl --kubeconfig kubeconfigs/dal-k8s-mgmt-1 describe server 00d03115-0000-0000-0000-e45f019d4ca8
Name:         00d03115-0000-0000-0000-e45f019d4ca8
Namespace:
Labels:       region=au-mel
              zone=indigo
...
Events:
  Type    Reason             Age   From                     Message
  ----    ------             ----  ----                     -------
  Normal  Server Allocation  86s   caps-controller-manager  Server as allocated via serverclass "rpi4.8gb.arm64" for metal machine "dal-k8s-core-1-cp-tnp8c".
```
