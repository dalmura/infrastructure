# Creating workload cluster dal-k8s-core-1

After configuring Sidero with our Server Classes and Environment, we're ready to create dal-k8s-core-1

To do this you'll have to have onboarded:
* 3x rpi4.4gb.arm64 for the Control Plane
* 3x rpi4.8gb.arm64 for Worker Pool #1

## Create the cluster in Sidero

```bash
mkdir -p sidero/clusters/

export CONTROL_PLANE_SERVERCLASS=rpi4.4gb.arm64
# Temporary until we have rpi4.4gb.arm64 in stock
export CONTROL_PLANE_SERVERCLASS=rpi4.8gb.arm64
export WORKER_SERVERCLASS=rpi4.8gb.arm64
export TALOS_VERSION=v1.3.1
export KUBERNETES_VERSION=v1.26.0
export CONTROL_PLANE_PORT=6443
export CONTROL_PLANE_ENDPOINT=192.168.77.3

clusterctl generate cluster dal-k8s-core-1 \
    -i sidero \
    --kubeconfig kubeconfigs/dal-k8s-mgmt-1 \
    --target-namespace sidero-system \
    > sidero/clusters/dal-k8s-core-1.yaml
```

The above will create a 'cluster configuration' that we can apply back to k8s to kick off creation of the cluster. It contains the following Resources in 3 logical groups (cluster, control plane, worker pools). The diagram also shows off an extra Worker Pool that isn't generated by default, but just shows how you'd go about having multiple Server Classes in a single cluster.

![cluster api hierarchy](imgs/core-cluster-api-resources.jpg?raw=true "Cluster API Hierarchy")

All the above Resources descriptions can be found conveniently on the [Sidero resources page](https://www.sidero.dev/latest/overview/resources/)

We are using `rpi4.4gb.arm64` Server Class for the Control Plane nodes, `rpi4.8gb.arm64` Server Class for the Worker nodes, latest support versions for Talos and k8s and `192.168.77.3` as our allocated VIP from our [network config](https://github.com/dalmura/network/blob/main/sites/indigo/networks.yml#L53).

Instead of simply applying the generated yaml back, we're going to break it up into:
1. `sidero/clusters/dal-k8s-core-1/control-plane.yaml` - Cluster & Control Plane
2. `sidero/clusters/dal-k8s-core-1/worker-pool-rpi4-8gb-arm64.yaml` - Worker Pool (rpi4.8gb.arm64)
3. `sidero/clusters/dal-k8s-core-1/worker-pool-dell-r320-amd64.yaml` - Worker Pool (dell.r320.amd64)

We'll then apply these back to k8s:
```bash
kubectl apply --kubeconfig kubeconfigs/dal-k8s-mgmt-1 -f sidero/clusters/dal-k8s-core-1/control-plane.yaml

kubectl apply --kubeconfig kubeconfigs/dal-k8s-mgmt-1 -f sidero/clusters/dal-k8s-core-1/worker-pool-rpi4-8gb-arm64.yaml

kubectl apply --kubeconfig kubeconfigs/dal-k8s-mgmt-1 -f sidero/clusters/dal-k8s-core-1/worker-pool-dell-r320-amd64.yaml
```
